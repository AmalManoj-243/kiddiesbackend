<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fruit Ninja Game</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { background: linear-gradient(90deg, #f9fbe7 0%, #ffe0b2 100%); }
    #game-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; min-width: 100vw; min-height: 100vh; max-width: 100vw; max-height: 100vh; touch-action: none; overflow: hidden; z-index: 10; }
    .centered { text-align: center; }
    </style>
</head>
<body>
    <div class="container-fluid mt-2 position-relative" style="max-width:100vw; padding:0;">
        <h2 class="centered mb-2" style="font-family: 'Fredoka One', cursive; color: #43a047; font-size:2rem;">Fruit Ninja Game</h2>
        <div class="centered mb-2" style="font-size:1.1rem;color:#333;background:#fff8e1;border-radius:12px;padding:8px 16px;max-width:98vw;margin:0 auto;">
            Slice the flying fruits by dragging across them! Score points for each sliced fruit. Miss 5 fruits and the game ends.<br>Use mouse or touch to slice.
        </div>
        <div id="game-container"></div>
        <div class="centered mt-2 mb-2">
            <a href="/kids/home/" class="btn btn-outline-primary" style="font-size:1.2rem;padding:10px 24px;border-radius:16px;">Back to Kids Home</a>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <script>

    function getLandscapeDimensions() {
        let w = window.innerWidth;
        let h = window.innerHeight;
        if (h > w) {
            // Swap to force landscape
            [w, h] = [h, w];
        }
        return { width: w, height: h };
    }
    let { width: gameWidth, height: gameHeight } = getLandscapeDimensions();

    // Overlay for portrait mode
    function showRotateOverlay() {
        let overlay = document.getElementById('rotate-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'rotate-overlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.background = 'rgba(255,235,59,0.95)';
            overlay.style.zIndex = '9999';
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.innerHTML = '<div style="font-size:2.2rem;color:#e53935;font-family:Fredoka One, cursive;background:#fff8e1;padding:32px 48px;border-radius:32px;box-shadow:0 4px 24px #e5393533;">Please rotate your device to landscape mode to play Fruit Ninja!</div>';
            document.body.appendChild(overlay);
        }
        overlay.style.display = 'flex';
    }
    function hideRotateOverlay() {
        let overlay = document.getElementById('rotate-overlay');
        if (overlay) overlay.style.display = 'none';
    }

    // Responsive resize for full screen and landscape enforcement
    window.addEventListener('resize', () => {
        let dims = getLandscapeDimensions();
        gameWidth = dims.width;
        gameHeight = dims.height;
        if (window.game && window.game.scale) {
            window.game.scale.resize(gameWidth, gameHeight);
        }
        // Show overlay if portrait
        if (window.innerHeight > window.innerWidth) {
            showRotateOverlay();
        } else {
            hideRotateOverlay();
        }
    });

    // Initial overlay check
    if (window.innerHeight > window.innerWidth) {
        showRotateOverlay();
    }

    // Responsive resize for full screen
    window.addEventListener('resize', () => {
        gameWidth = window.innerWidth;
        gameHeight = window.innerHeight;
        if (window.game && window.game.scale) {
            window.game.scale.resize(gameWidth, gameHeight);
        }
    });
    class ModeSelectScreen extends Phaser.Scene {
        constructor() { super('ModeSelectScreen'); }
        preload() {
            this.load.audio('bgmusic', 'https://res.cloudinary.com/djc3qirsl/video/upload/v1758154080/noncopyright-music-pianos-295174_yjqmrs.mp3');
        }
        create() {
            this.cameras.main.setBackgroundColor('#ffe0b2');
            // Title
            this.add.text(gameWidth/2, gameHeight/2-140, 'Fruit Ninja', {
                fontSize: '54px', fill: '#43a047', fontFamily: 'Fredoka One', stroke: '#fff', strokeThickness: 6, shadow: { offsetX: 2, offsetY: 2, color: '#ffe0b2', blur: 8, fill: true }
            }).setOrigin(0.5);
            // Subtitle
            this.add.text(gameWidth/2, gameHeight/2-80, 'Select Mode', {
                fontSize: '36px', fill: '#e53935', fontFamily: 'Fredoka One', backgroundColor: '#fff8e1', padding: { left: 18, right: 18, top: 8, bottom: 8 }, borderRadius: 16, shadow: { offsetX: 1, offsetY: 1, color: '#ffe0b2', blur: 6, fill: true }
            }).setOrigin(0.5);

            // Home button (top right)
            const homeBtn = this.add.text(gameWidth-32, 24, 'Home', {
                fontSize: '22px', fill: '#fff', backgroundColor: '#e53935', padding: { left: 18, right: 18, top: 8, bottom: 8 }, borderRadius: 12, fontFamily: 'Fredoka One', shadow: { offsetX: 1, offsetY: 1, color: '#e53935', blur: 6, fill: true }
            }).setOrigin(1,0).setInteractive();
            homeBtn.setDepth(10);
            homeBtn.on('pointerdown', () => {
                window.location.href = '/';
            });

            // Card backgrounds
            let cardY = gameHeight/2+10;
            let cardSpacing = 120;
            let cardWidth = 340;
            let cardHeight = 80;
            let cardRadius = 28;
            // Single Player Card
            let singleCard = this.add.graphics();
            singleCard.fillStyle(0xffffff, 1);
            singleCard.fillRoundedRect(gameWidth/2-cardWidth/2, cardY-cardHeight/2, cardWidth, cardHeight, cardRadius);
            singleCard.lineStyle(4, 0x43a047, 1);
            singleCard.strokeRoundedRect(gameWidth/2-cardWidth/2, cardY-cardHeight/2, cardWidth, cardHeight, cardRadius);
            // Multiplayer Card
            let multiCard = this.add.graphics();
            multiCard.fillStyle(0xfff8e1, 1);
            multiCard.fillRoundedRect(gameWidth/2-cardWidth/2, cardY+cardSpacing-cardHeight/2, cardWidth, cardHeight, cardRadius);
            multiCard.lineStyle(4, 0xe53935, 1);
            multiCard.strokeRoundedRect(gameWidth/2-cardWidth/2, cardY+cardSpacing-cardHeight/2, cardWidth, cardHeight, cardRadius);

            // Single Player Icon & Button
            let singleIcon = this.add.text(gameWidth/2-cardWidth/2+40, cardY, 'ðŸ‘¤', { fontSize: '44px' }).setOrigin(0.5);
            let singleBtn = this.add.text(gameWidth/2, cardY, 'Single Player', {
                fontSize: '32px', fill: '#43a047', fontFamily: 'Fredoka One', fontStyle: 'bold', backgroundColor: 'rgba(67,160,71,0.07)', padding: { left: 18, right: 18, top: 8, bottom: 8 }, borderRadius: 12
            }).setOrigin(0.5).setInteractive();

            // Multiplayer Icon & Button
            let multiIcon = this.add.text(gameWidth/2-cardWidth/2+40, cardY+cardSpacing, 'ðŸ‘¥', { fontSize: '44px' }).setOrigin(0.5);
            let multiBtn = this.add.text(gameWidth/2, cardY+cardSpacing, 'Multiplayer', {
                fontSize: '32px', fill: '#e53935', fontFamily: 'Fredoka One', fontStyle: 'bold', backgroundColor: 'rgba(229,57,53,0.07)', padding: { left: 18, right: 18, top: 8, bottom: 8 }, borderRadius: 12
            }).setOrigin(0.5).setInteractive();

            // Hover/touch effects
            singleBtn.on('pointerover', () => singleBtn.setStyle({ backgroundColor: '#43a047', fill: '#fff' }));
            singleBtn.on('pointerout', () => singleBtn.setStyle({ backgroundColor: 'rgba(67,160,71,0.07)', fill: '#43a047' }));
            singleBtn.on('pointerdown', () => {
                singleBtn.setStyle({ backgroundColor: '#388e3c', fill: '#fff' });
                this.bgmusic.stop();
                this.scene.start('LoadScreen', { mode: 'single' });
            });
            multiBtn.on('pointerover', () => multiBtn.setStyle({ backgroundColor: '#e53935', fill: '#fff' }));
            multiBtn.on('pointerout', () => multiBtn.setStyle({ backgroundColor: 'rgba(229,57,53,0.07)', fill: '#e53935' }));
            multiBtn.on('pointerdown', () => {
                multiBtn.setStyle({ backgroundColor: '#b71c1c', fill: '#fff' });
                this.bgmusic.stop();
                this.scene.start('LoadScreen', { mode: 'multi' });
            });

            this.bgmusic = this.sound.add('bgmusic', { loop: true, volume: 0.45 });
            this.bgmusic.play();
        }
    }

    class LoadScreen extends Phaser.Scene {
        constructor() { super('LoadScreen'); }
        preload() {
            // No need to reload bgmusic
        }
        create(data) {
            this.cameras.main.setBackgroundColor('#ffe0b2');
            this.add.text(gameWidth/2, gameHeight/2-80, 'Fruit Ninja', { fontSize: '44px', fill: '#43a047', fontFamily: 'Fredoka One' }).setOrigin(0.5);
            let modeText = data && data.mode === 'multi' ? 'Multiplayer' : 'Single Player';
            this.add.text(gameWidth/2, gameHeight/2-40, modeText, { fontSize: '28px', fill: '#e53935', fontFamily: 'Fredoka One' }).setOrigin(0.5);
            let newGameBtn = this.add.text(gameWidth/2, gameHeight/2, 'New Game', { fontSize: '32px', fill: '#fff', backgroundColor:'#43a047', padding:{left:24,right:24,top:12,bottom:12}, borderRadius:16, fontFamily: 'Fredoka One' }).setOrigin(0.5).setInteractive();
            let settingsBtn = this.add.text(gameWidth/2, gameHeight/2+70, 'Settings', { fontSize: '28px', fill: '#43a047', backgroundColor:'#fff8e1', padding:{left:20,right:20,top:10,bottom:10}, borderRadius:12, fontFamily: 'Fredoka One' }).setOrigin(0.5).setInteractive();
            newGameBtn.on('pointerdown', () => {
                this.scene.start('FruitNinjaScene');
            });
            settingsBtn.on('pointerdown', () => {
                // You can add settings logic here
                this.add.text(gameWidth/2, gameHeight/2+130, 'Settings coming soon!', { fontSize: '22px', fill: '#e53935', fontFamily: 'Fredoka One' }).setOrigin(0.5);
            });
        }
    }

    class FruitNinjaScene extends Phaser.Scene {
        constructor() { super('FruitNinjaScene'); }
        preload() {
            this.load.image('tomato', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756351019/media/lessons/colors/apple_d3cva5.png');
            this.load.image('cauliflower', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756898045/media/movies/tq3hsv7o44uxaluibd5w.png');
            this.load.image('carrot', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756898005/media/movies/u7aewcl59arygvpdbgms.png');
            this.load.image('cabbage', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756898003/media/movies/uj8zqz0qesasztebu5bk.png');
            this.load.image('apple', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756897997/media/movies/uno1akwgos6rkbtrlqx6.webp');
            this.load.image('banana', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756897909/media/movies/enfk0xfgmnqbq0ikioq2.png');
            this.load.image('orange', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756898028/media/movies/eruzjgwp2ld4x85jgb5f.png'); // Use orange.png for orange
            this.load.image('watermelon', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756898045/media/movies/tq3hsv7o44uxaluibd5w.png');
            this.load.image('strawberry', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756898039/media/movies/oxsaqz8ym7fuixixbwof.png');
            this.load.image('grapes', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756898018/media/movies/kfmehafohwbeswcldlun.png');
            this.load.image('radishh', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756898036/media/movies/q4m2qktdn36nrdoibfgt.png');
            this.load.image('pumpkin', 'https://res.cloudinary.com/djc3qirsl/image/upload/v1756898032/media/movies/v1jiixyvdsdqkxrgsopy.png');
            this.load.audio('slice', 'https://res.cloudinary.com/djc3qirsl/video/upload/v1758153594/knife-slice-41231_qdwkue.mp3');
            this.load.audio('countdown', 'https://res.cloudinary.com/djc3qirsl/video/upload/v1758154694/robotic-countdown-43935_mzufpk.mp3');
        }
        create() {
            // Points for each fruit type
            this.fruitPoints = {
                apple: 2,
                banana: 1,
                orange: 3,
                watermelon: 5,
                strawberry: 4,
                grapes: 2,
                radishh: 6,
                pumpkin: 4,
                cabbage: 3,
                carrot: 2,
                cauliflower: 3,
                tomato: 2
            };
            this.fruitTypes = ['apple', 'banana', 'orange', 'watermelon', 'strawberry', 'grapes', 'radishh', 'pumpkin', 'cabbage', 'carrot', 'cauliflower', 'tomato'];
            this.fruitSizes = {
                apple: 62,
                banana: 100,
                orange: 96,
                watermelon: 125,
                strawberry: 115,
                grapes: 104,
                radishh: 150,
                pumpkin: 100,
                cabbage: 120,
                carrot: 150,
                cauliflower: 95,
                tomato: 110
            };
            // Multiplayer: two players
            this.score1 = 0;
            this.score2 = 0;
            this.missed1 = 0;
            this.missed2 = 0;
            this.gameOver = false;
            this.cameras.main.setBackgroundColor('rgba(0,0,0,0)');
            this.fruits = [];

            // Hide UI until countdown finishes
            // Add vertical divider for split-screen effect (landscape)
            this.centerDivider = this.add.graphics();
            this.centerDivider.lineStyle(6, 0xcccccc, 0.8);
            this.centerDivider.beginPath();
            this.centerDivider.moveTo(gameWidth/2, 0);
            this.centerDivider.lineTo(gameWidth/2, gameHeight);
            this.centerDivider.strokePath();
            this.centerDivider.setVisible(false);
            // Player labels at top
            this.p1Label = this.add.text(gameWidth/4, 4, 'PLAYER 1', {
                fontSize: '18px', fill: '#43a047', fontFamily: 'Fredoka One', backgroundColor:'#fff8e1',
                padding:{left:10,right:10,top:2,bottom:2}, borderRadius:8
            }).setOrigin(0.5,0).setScrollFactor(0).setVisible(false);
            this.p2Label = this.add.text(gameWidth*3/4, 4, 'PLAYER 2', {
                fontSize: '18px', fill: '#1565c0', fontFamily: 'Fredoka One', backgroundColor:'#fff8e1',
                padding:{left:10,right:10,top:2,bottom:2}, borderRadius:8
            }).setOrigin(0.5,0).setScrollFactor(0).setVisible(false);
            // Left: P1 Score (top left), P1 Missed (bottom left)
            this.scoreText1 = this.add.text(16, 32, 'Score: 0', {
                fontSize: '22px', fill: '#43a047', fontFamily: 'Fredoka One', backgroundColor:'#fff8e1',
                padding:{left:10,right:10,top:2,bottom:2}, borderRadius:8
            }).setScrollFactor(0).setVisible(false);
            this.missedText1 = this.add.text(16, gameHeight-48, 'Missed: 0', {
                fontSize: '20px', fill: '#e53935', fontFamily: 'Fredoka One', backgroundColor:'#fff8e1',
                padding:{left:10,right:10,top:2,bottom:2}, borderRadius:8
            }).setScrollFactor(0).setVisible(false);
            // Right: P2 Score (top right), P2 Missed (bottom right)
            this.scoreText2 = this.add.text(gameWidth-16, 32, 'Score: 0', {
                fontSize: '22px', fill: '#1565c0', fontFamily: 'Fredoka One', backgroundColor:'#fff8e1',
                padding:{left:10,right:10,top:2,bottom:2}, borderRadius:8
            }).setOrigin(1,0).setScrollFactor(0).setVisible(false);
            this.missedText2 = this.add.text(gameWidth-16, gameHeight-48, 'Missed: 0', {
                fontSize: '20px', fill: '#e53935', fontFamily: 'Fredoka One', backgroundColor:'#fff8e1',
                padding:{left:10,right:10,top:2,bottom:2}, borderRadius:8
            }).setOrigin(1,1).setScrollFactor(0).setVisible(false);
            // Timer in center top
            this.timerText = this.add.text(gameWidth/2, 8, '', {
                fontSize: '24px', fill: '#ff9800', fontFamily: 'Fredoka One', backgroundColor:'#fff8e1',
                padding:{left:14,right:14,top:2,bottom:2}, borderRadius:8
            }).setOrigin(0.5, 0).setVisible(false);

            // Home button (top right)
            const homeBtn = this.add.text(gameWidth-32, 24, 'Home', {
                fontSize: '22px', fill: '#fff', backgroundColor: '#e53935', padding: { left: 18, right: 18, top: 8, bottom: 8 }, borderRadius: 12, fontFamily: 'Fredoka One', shadow: { offsetX: 1, offsetY: 1, color: '#e53935', blur: 6, fill: true }
            }).setOrigin(1,0).setInteractive();
            homeBtn.setDepth(10);
            homeBtn.on('pointerdown', () => {
                window.location.href = '/kids/home/';
            });
            countdownSound.play();
            const showCountdown = () => {
                let text = countdownNumbers[countdownIndex];
                let color = text === 'Go!' ? '#43a047' : '#e53935';
                let fontSize = text === 'Go!' ? '80px' : '72px';
                let countdownText = this.add.text(gameWidth/2, gameHeight/2, text, {
                    fontSize,
                    fill: color,
                    fontFamily: 'Fredoka One',
                    backgroundColor: text === 'Go!' ? '#fff8e1' : 'rgba(0,0,0,0.1)',
                    padding: { left: 32, right: 32, top: 16, bottom: 16 },
                    borderRadius: 24,
                    stroke: '#333',
                    strokeThickness: 6
                }).setOrigin(0.5);
                this.tweens.add({
                    targets: countdownText,
                    scale: { from: 0.7, to: 1.2 },
                    alpha: { from: 1, to: 0 },
                    duration: 900,
                    ease: 'Cubic.easeOut',
                    onComplete: () => {
                        countdownText.destroy();
                        countdownIndex++;
                        if (countdownIndex < countdownNumbers.length) {
                            setTimeout(showCountdown, 100);
                        } else {
                            // Reveal UI and start game logic
                            this.scoreText1.setVisible(true);
                            this.missedText1.setVisible(true);
                            this.scoreText2.setVisible(true);
                            this.missedText2.setVisible(true);
                            this.timerText.setVisible(true);
                            this.centerDivider.setVisible(true);
                            // Drop more fruits at a time for multiplayer challenge
                            this.fruitTimer = this.time.addEvent({ delay: 900, callback: () => {
                                // Drop 2-4 fruits per tick
                                let numFruits = Phaser.Math.Between(2, 4);
                                for (let i = 0; i < numFruits; i++) {
                                    this.launchFruit();
                                }
                            }, callbackScope: this, loop: true });
                            // Enable slicing for both drag (pointermove) and tap/touch (pointerdown)
                            this.input.on('pointermove', this.sliceFruitsMultiplayer, this);
                            this.input.on('pointerdown', this.sliceFruitsMultiplayer, this);
                            this.timeoutDuration = 60; // seconds
                            this.timeLeft = this.timeoutDuration;
                            this.timerText.setText('Time: ' + this.timeLeft);
                            this.timeoutEvent = this.time.addEvent({ delay: 1000, callback: () => {
                                if (this.gameOver) return;
                                this.timeLeft--;
                                this.timerText.setText('Time: ' + this.timeLeft);
                                if (this.timeLeft <= 0) {
                                    this.endGame(true);
                                }
                            }, callbackScope: this, loop: true });
                        }
                    }
                });
            };
            showCountdown();
        }
        launchFruit() {
            if (this.gameOver) return;
            let fruitType = Phaser.Utils.Array.GetRandom(this.fruitTypes);
            let size = this.fruitSizes[fruitType] || 44;
            // Multiplayer fairness: spawn from top or bottom randomly
            let spawnFromTop = Phaser.Math.Between(0, 1) === 0;
            let x = Phaser.Math.Between(60, gameWidth-60);
            let y = spawnFromTop ? -40 : gameHeight + 40;
            let fruit = this.add.image(x, y, fruitType).setOrigin(0.5).setDisplaySize(size, size);
            this.physics.add.existing(fruit);
            // Launch direction: if from top, go down; if from bottom, go up
            let angle;
            let speed = Phaser.Math.Between(420, 620);
            if (spawnFromTop) {
                // Downward angle
                angle = Phaser.Math.FloatBetween(Math.PI/3, 2*Math.PI/3);
                fruit.body.setGravityY(-500); // gravity pulls up, so fruit falls down
            } else {
                // Upward angle
                angle = Phaser.Math.FloatBetween(-Math.PI/3, -2*Math.PI/3);
                fruit.body.setGravityY(500); // gravity pulls down, so fruit goes up
            }
            fruit.body.setVelocity(Math.cos(angle)*speed, Math.sin(angle)*speed);
            fruit.body.setCollideWorldBounds(false);
            fruit.sliced = false;
            fruit.fruitType = fruitType;
            fruit.fruitSize = size;
            this.fruits.push(fruit);
        }
        sliceFruitsMultiplayer(pointer) {
            if (this.gameOver) return;
            // Determine which player: left half = P1, right half = P2
            let isP1 = pointer.x < gameWidth/2;
            let scoreKey = isP1 ? 'score1' : 'score2';
            let scoreTextKey = isP1 ? 'scoreText1' : 'scoreText2';
            for (let i = this.fruits.length - 1; i >= 0; i--) {
                let fruit = this.fruits[i];
                // Only allow slicing if fruit is in player's half
                if (!fruit.sliced && Phaser.Math.Distance.Between(pointer.x, pointer.y, fruit.x, fruit.y) < fruit.fruitSize/2 && ((isP1 && fruit.x < gameWidth/2) || (!isP1 && fruit.x >= gameWidth/2))) {
                    fruit.sliced = true;
                    let points = this.fruitPoints[fruit.fruitType] || 1;
                    this[scoreKey] += points;
                    this[scoreTextKey].setText((isP1 ? 'P1' : 'P2') + ' Score: ' + this[scoreKey] + ' (+' + points + ')');

                    // Play slice sound
                    this.sound.play('slice');

                    // Popup showing points earned, with player indicator
                    const popup = this.add.text(fruit.x, fruit.y - 30, `${isP1 ? 'P1' : 'P2'} +${points}`, {
                        font: 'bold 32px Arial',
                        fill: isP1 ? '#43a047' : '#1565c0',
                        stroke: '#333',
                        strokeThickness: 4,
                        backgroundColor: 'rgba(0,0,0,0.4)'
                    }).setOrigin(0.5);
                    this.tweens.add({
                        targets: popup,
                        y: popup.y - 40,
                        alpha: 0,
                        duration: 800,
                        onComplete: () => popup.destroy()
                    });

                    // Cutting effect: slash line
                    let slash = this.add.graphics();
                    slash.lineStyle(6, isP1 ? 0x43a047 : 0x1565c0, 0.8);
                    slash.beginPath();
                    slash.moveTo(pointer.x-30, pointer.y-30);
                    slash.lineTo(pointer.x+30, pointer.y+30);
                    slash.strokePath();
                    this.tweens.add({ targets: slash, alpha: 0, duration: 350, onComplete: () => slash.destroy() });
                    // Split fruit halves
                    let halfSize = Math.round(fruit.fruitSize/2);
                    let half1 = this.add.image(fruit.x-10, fruit.y, fruit.fruitType).setOrigin(0.5).setDisplaySize(halfSize, fruit.fruitSize).setAngle(-20);
                    let half2 = this.add.image(fruit.x+10, fruit.y, fruit.fruitType).setOrigin(0.5).setDisplaySize(halfSize, fruit.fruitSize).setAngle(20);
                    this.tweens.add({ targets: half1, x: half1.x-40, y: half1.y+40, alpha: 0, angle: -60, duration: 500, onComplete: () => half1.destroy() });
                    this.tweens.add({ targets: half2, x: half2.x+40, y: half2.y+40, alpha: 0, angle: 60, duration: 500, onComplete: () => half2.destroy() });
                    this.tweens.add({ targets: fruit, alpha: 0, duration: 200, onComplete: () => fruit.destroy() });
                    this.fruits.splice(i, 1);
                }
            }
        }
        update() {
            if (this.gameOver) return;
            for (let i = this.fruits.length - 1; i >= 0; i--) {
                let fruit = this.fruits[i];
                if (fruit.y > gameHeight+40 && !fruit.sliced) {
                    fruit.destroy();
                    this.fruits.splice(i, 1);
                    // Missed: assign to player based on fruit x position (left/right)
                    if (fruit.x < gameWidth/2) {
                        this.missed1 += 1;
                        this.missedText1.setText('P1 Missed: ' + this.missed1);
                    } else {
                        this.missed2 += 1;
                        this.missedText2.setText('P2 Missed: ' + this.missed2);
                    }
                    // No game over on missed fruits
                }
            }
        }
        endGame(timeout=false) {
            this.gameOver = true;
            this.fruitTimer.remove(false);
            if (this.timeoutEvent) this.timeoutEvent.remove(false);
            // Hide all gameplay elements
            this.children.each(child => {
                if (child !== this.cameras.main) {
                    child.setVisible(false);
                }
            });
            // End game overlay
            const overlay = this.add.graphics();
            overlay.fillStyle(0x212121, 0.92);
            overlay.fillRect(0, 0, gameWidth, gameHeight);
            overlay.setDepth(100);
            // Card
            const card = this.add.graphics();
            card.fillStyle(0xffffff, 1);
            card.fillRoundedRect(gameWidth/2-240, gameHeight/2-180, 480, 360, 40);
            card.setDepth(101);
            // Title
            const title = this.add.text(gameWidth/2, gameHeight/2-120, timeout ? 'Time Up!' : 'Game Over!', {
                fontSize: '54px', fill: '#e53935', fontFamily: 'Fredoka One', fontWeight: 'bold', align: 'center', backgroundColor:'#fff8e1', padding:{left:24,right:24,top:12,bottom:12}, borderRadius:24, shadow: { offsetX: 2, offsetY: 2, color: '#ffe0b2', blur: 8, fill: true }
            }).setOrigin(0.5);
            title.setDepth(102);
            // Scores
            const scoreText = this.add.text(gameWidth/2, gameHeight/2-40, `P1 Score: ${this.score1}\nP2 Score: ${this.score2}`, {
                fontSize: '32px', fill: '#43a047', fontFamily: 'Fredoka One', align: 'center', backgroundColor:'#fff8e1', padding:{left:18,right:18,top:8,bottom:8}, borderRadius:16
            }).setOrigin(0.5);
            scoreText.setDepth(102);
            // Missed
            const missedText = this.add.text(gameWidth/2, gameHeight/2+30, `P1 Missed: ${this.missed1}\nP2 Missed: ${this.missed2}`, {
                fontSize: '24px', fill: '#e53935', fontFamily: 'Fredoka One', align: 'center', backgroundColor:'#fff8e1', padding:{left:12,right:12,top:6,bottom:6}, borderRadius:12
            }).setOrigin(0.5);
            missedText.setDepth(102);
            // Restart button
            const restartBtn = this.add.text(gameWidth/2, gameHeight/2+90, 'Restart', {
                fontSize: '28px', fill: '#fff', backgroundColor: '#43a047', padding: { left: 32, right: 32, top: 12, bottom: 12 }, borderRadius: 16, fontFamily: 'Fredoka One', shadow: { offsetX: 1, offsetY: 1, color: '#43a047', blur: 6, fill: true }
            }).setOrigin(0.5).setInteractive();
            restartBtn.setDepth(103);
            restartBtn.on('pointerdown', () => {
                this.scene.restart();
            });
            // Back button (returns to mode select screen)
            const backBtn = this.add.text(gameWidth/2, gameHeight/2+150, 'Back', {
                fontSize: '28px', fill: '#fff', backgroundColor: '#e53935', padding: { left: 32, right: 32, top: 12, bottom: 12 }, borderRadius: 16, fontFamily: 'Fredoka One', shadow: { offsetX: 1, offsetY: 1, color: '#e53935', blur: 6, fill: true }
            }).setOrigin(0.5).setInteractive();
            backBtn.setDepth(103);
            backBtn.on('pointerdown', () => {
                this.scene.start('ModeSelectScreen');
            });
        }
    }
    window.game = new Phaser.Game({
        type: Phaser.AUTO,
        width: gameWidth,
        height: gameHeight,
        parent: 'game-container',
        physics: { default: 'arcade', arcade: { gravity: { y: 0 }, debug: false } },
        scene: [ModeSelectScreen, LoadScreen, FruitNinjaScene]
    });
    </script>
</body>
</html>

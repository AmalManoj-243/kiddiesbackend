<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Digital Drawing</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #fff;
    box-sizing: border-box;
    border: 8px solid #00b8ff;
    border-radius: 40px;
    box-shadow: 0 4px 32px #00b8ff22;
  }
  #drawingCanvas { position: absolute; top: 80px; left: 0; width: 100vw; height: calc(100vh - 80px); background: #fff; display: block; cursor: crosshair; z-index: 1; }
  .drawing-toolbar {
    position: sticky;
    top: 0;
    left: 0;
    width: 100vw;
    min-height: 80px;
    background: #f8f9fa;
    border-bottom: 2px solid #00b8ff;
    box-shadow: 0 4px 16px #00b8ff33;
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    align-items: flex-start;
    z-index: 100;
    padding: 8px 8px 8px 8px;
  border-radius: 32px;
  }
  .toolbar-row {
    display: flex;
    flex-direction: row;
    gap: 16px;
    align-items: center;
    width: 100%;
    margin-bottom: 4px;
    justify-content: flex-start;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: #00b8ff #e0e0e0;
  }
  .toolbar-section { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; min-width: 120px; }
  .toolbar-actions { display: flex; flex-direction: row; gap: 6px; align-items: center; margin-top: 0; margin-bottom: 0; }
  .drawing-toolbar label, .drawing-toolbar select, .drawing-toolbar button, .drawing-toolbar .tool-btn, .drawing-toolbar .kids-btn { margin: 0 2px; font-size: 1rem; }
  .drawing-toolbar label, .drawing-toolbar select, .drawing-toolbar button, .drawing-toolbar .tool-btn, .drawing-toolbar .kids-btn { margin: 0 6px; font-size: 2.2rem; }
  .tool-btn {
    background: #fff;
    color: #00b8ff;
    border: 2px solid #00b8ff;
    padding: 16px 24px;
    border-radius: 18px;
    min-width: 72px;
    min-height: 72px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    box-shadow: 0 2px 8px #00b8ff22;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    margin-bottom: 2px;
  }
  .tool-btn.active {
    background: #00b8ff;
    color: #fff;
    box-shadow: 0 4px 16px #00b8ff44;
  }
  .kids-btn {
    background: #fff;
    color: #00b8ff;
    border: 2px solid #00b8ff;
    padding: 16px 24px;
    border-radius: 18px;
    min-width: 72px;
    min-height: 72px;
    font-weight: 700;
    font-size: 2rem;
    box-shadow: 0 2px 8px #00b8ff22;
    margin-bottom: 2px;
  }
  .kids-btn.save { background:#00b8ff;color:#fff; }
  .drawing-toolbar select, .drawing-toolbar input[type="color"], .drawing-toolbar input[type="range"] { height: 48px; font-size: 1.4rem; }
  .drawing-toolbar label { font-weight: 700; }
  .drawing-toolbar::-webkit-scrollbar { height: 8px; background: #e0e0e0; }
  .drawing-toolbar::-webkit-scrollbar-thumb { background: #00b8ff; border-radius: 4px; }
  @media (max-width: 1200px) { .toolbar-row { gap: 6px; } .tool-btn, .kids-btn { min-width: 28px; font-size: 0.95rem; padding: 3px 6px; } }
  @media (max-width: 767px) { .drawing-toolbar { font-size: 0.85rem; padding: 0 2px; } .toolbar-row { gap: 3px; } .tool-btn, .kids-btn { min-width: 24px; font-size: 0.8rem; padding: 2px 2px; } }
  @media (orientation: landscape) and (max-width: 900px) {
    .drawing-toolbar {
      min-height: 40px;
      height: 40px;
      padding-top: 2px;
      padding-bottom: 2px;
    }
    .tool-btn, .kids-btn {
      min-width: 40px;
      min-height: 40px;
      padding: 4px 8px;
      font-size: 1rem;
    }
    .drawing-toolbar label, .drawing-toolbar select, .drawing-toolbar button, .drawing-toolbar .tool-btn, .drawing-toolbar .kids-btn {
      font-size: 1rem;
    }
  }
  </style>
</head>
<body>
<div class="drawing-toolbar">
  <div class="toolbar-row">
    <label>Brush Size:
      <input type="range" id="brushSize" min="1" max="64" value="6">
    </label>
    <label>Brush Color:
      <input type="color" id="brushColor" value="#000000">
    </label>
    <label>Brush Type:
      <select id="brushType">
        <option value="pencil">Pencil</option>
        <option value="charcoal">Charcoal</option>
        <option value="graphite">Graphite</option>
        <option value="ink">Ink Pen</option>
        <option value="marker">Marker</option>
        <option value="airbrush">Airbrush</option>
        <option value="calligraphy">Calligraphy</option>
        <option value="eraser">Eraser</option>
        <option value="smudge">Smudge</option>
        <option value="blend">Blend</option>
        <option value="spray">Spray</option>
        <option value="pattern">Pattern Brush</option>
        <option value="dotted">Dotted Line</option>
        <option value="hatch">Hatching</option>
        <option value="crosshatch">Crosshatch</option>
      </select>
    </label>
    <label style="font-size:1.2rem; margin-left:16px;">
      Load Image:
      <input type="file" id="imageLoader" accept="image/*" style="font-size:1.2rem; padding:4px;">
    </label>
  </div>
  <div class="toolbar-row">
    <button onclick="setTool('brush')" id="brushBtn" class="tool-btn active" title="Sketch"><i class="fas fa-pencil-alt"></i></button>
    <button onclick="setTool('line')" id="lineBtn" class="tool-btn" title="Line"><i class="fas fa-slash"></i></button>
    <button onclick="setTool('rect')" id="rectBtn" class="tool-btn" title="Rectangle"><i class="far fa-square"></i></button>
    <button onclick="setTool('circle')" id="circleBtn" class="tool-btn" title="Circle"><i class="far fa-circle"></i></button>
    <button onclick="setTool('ellipse')" id="ellipseBtn" class="tool-btn" title="Ellipse"><i class="far fa-circle"></i></button>
    <button onclick="setTool('polygon')" id="polygonBtn" class="tool-btn" title="Polygon"><i class="fas fa-draw-polygon"></i></button>
    <button onclick="setTool('fill')" id="fillBtn" class="tool-btn" title="Fill"><i class="fas fa-fill-drip"></i></button>
    <button onclick="setTool('text')" id="textBtn" class="tool-btn" title="Text"><i class="fas fa-font"></i></button>
    <button onclick="clearCanvas()" class="kids-btn" title="Clear"><i class="fas fa-trash"></i></button>
    <button onclick="saveDrawing()" class="kids-btn save" title="Save"><i class="fas fa-save"></i></button>
    <button onclick="undo()" class="kids-btn" title="Undo"><i class="fas fa-undo"></i></button>
    <button onclick="redo()" class="kids-btn" title="Redo"><i class="fas fa-redo"></i></button>
    <span id="saveMsg" style="color:#00b8ff;font-weight:600;"></span>
  </div>
  <div class="toolbar-row">
  </div>
</div>
<div id="levelSampleImg" style="position:fixed;top:240px;left:23px;z-index:9998;display:none;"></div>
<canvas id="drawingCanvas" width="1920" height="1080"></canvas>

<div id="modeSelect" class="kids-modal">
  <h2 class="kids-title">üé® Choose Drawing Mode</h2>
  <div class="kids-mode-btns">
    <button onclick="startSelfDrawing()" class="kids-mode-btn self">üñåÔ∏è Self Drawing</button>
    <button onclick="showLevelChooser()" class="kids-mode-btn levels">üåü Levels Mode</button>
  </div>
</div>
<div id="levelChooser" class="kids-modal" style="display:none;">
  <h2 class="kids-title">üåü Choose a Level</h2>
  <div id="levelBtns" class="kids-level-btns kids-level-btns-scroll"></div>
  <button onclick="backToModeSelect()" class="kids-back-btn">‚¨ÖÔ∏è Back</button>
</div>

<script>
  const canvas = document.getElementById('drawingCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false, tool = 'brush', startX = 0, startY = 0, brushSize = 6, brushColor = '#000000', snapshot = null;
  let brushType = document.getElementById('brushType').value;
  let history = [], redoStack = [];
  let lastDotX = null, lastDotY = null;
  let polygonPoints = [];
  let isDrawingPolygon = false;
  let selectedArea = null;

  function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function setTool(selected) {
    tool = selected;
    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
    if(selected==='brush') document.getElementById('brushBtn').classList.add('active');
    if(selected==='line') document.getElementById('lineBtn').classList.add('active');
    if(selected==='rect') document.getElementById('rectBtn').classList.add('active');
    if(selected==='circle') document.getElementById('circleBtn').classList.add('active');
    if(selected==='ellipse') document.getElementById('ellipseBtn').classList.add('active');
    if(selected==='polygon') document.getElementById('polygonBtn').classList.add('active');
    if(selected==='fill') document.getElementById('fillBtn').classList.add('active');
    if(selected==='text') document.getElementById('textBtn').classList.add('active');
  }

  document.getElementById('brushSize').addEventListener('input', function() { brushSize = this.value; });
  document.getElementById('brushColor').addEventListener('input', function() { brushColor = this.value; });
  document.getElementById('brushType').addEventListener('change', function() { brushType = this.value; });

  function getXY(e) {
    const rect = canvas.getBoundingClientRect();
    let x, y;
    if (e.touches) {
      x = e.touches[0].clientX - rect.left;
      y = e.touches[0].clientY - rect.top;
    } else {
      x = e.clientX - rect.left;
      y = e.clientY - rect.top;
    }
    return { x, y };
  }

  function saveState() {
    history.push(canvas.toDataURL());
    if(history.length > 50) history.shift();
    redoStack = [];
  }
  function undo() {
    if(history.length < 2) return;
    redoStack.push(history.pop());
    let img = new Image();
    img.src = history[history.length-1];
    img.onload = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); };
  }
  function redo() {
    if(redoStack.length === 0) return;
    let img = new Image();
    img.src = redoStack.pop();
    img.onload = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); history.push(img.src); };
  }

  // Add custom text input box
  const textInputBox = document.createElement('div');
  textInputBox.style.position = 'fixed';
  textInputBox.style.display = 'none';
  textInputBox.style.zIndex = '1000';
  textInputBox.innerHTML = `
    <input id="canvasTextInput" type="text" style="font-size:1.2rem;padding:6px 12px;border-radius:8px;border:1px solid #00b8ff;outline:none;" placeholder="Enter text...">
    <button id="canvasTextOk" style="font-size:1.1rem;padding:6px 16px;margin-left:8px;background:#00b8ff;color:#fff;border:none;border-radius:8px;">OK</button>
    <button id="canvasTextCancel" style="font-size:1.1rem;padding:6px 16px;margin-left:4px;background:#eee;color:#333;border:none;border-radius:8px;">Cancel</button>
  `;
  document.body.appendChild(textInputBox);
  let textInputPos = {x:0, y:0};

  function showTextInput(x, y) {
    textInputBox.style.left = (x + 20) + 'px';
    textInputBox.style.top = (y + 80) + 'px';
    textInputBox.style.display = 'block';
    document.getElementById('canvasTextInput').value = '';
    document.getElementById('canvasTextInput').focus();
    textInputPos = {x, y};
    // Draw a temporary dot for reference
    ctx.save();
    ctx.beginPath();
    ctx.arc(x, y, 6, 0, 2 * Math.PI);
    ctx.fillStyle = '#00b8ff';
    ctx.globalAlpha = 0.7;
    ctx.fill();
    ctx.restore();
  }
  function hideTextInput() {
    textInputBox.style.display = 'none';
  }
  document.getElementById('canvasTextOk').onclick = function() {
    const val = document.getElementById('canvasTextInput').value;
    if(val) {
      // Remove reference dot by redrawing last saved state
      let img = new Image();
      img.src = history[history.length-1];
      img.onload = function() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        ctx.font = `${brushSize*3}px Arial`;
        ctx.fillStyle = brushColor;
        ctx.fillText(val, textInputPos.x, textInputPos.y);
        saveState();
      };
    }
    hideTextInput();
  };
  document.getElementById('canvasTextCancel').onclick = function() { hideTextInput(); };

  function startDraw(e) {
    drawing = true;
    const {x, y} = getXY(e);
    startX = x; startY = y;
    if(tool==='brush') {
      lastDotX = null; lastDotY = null;
      draw(e);
    }
    if(tool==='fill') floodFill(x, y, brushColor);
    if(['line','rect','circle','ellipse','polygon'].includes(tool)) snapshot = ctx.getImageData(0,0,canvas.width,canvas.height);
    if(tool==='text') {
      showTextInput(x, y);
      drawing = false;
      ctx.beginPath();
      return;
    }
    saveState();
  }
  function endDraw(e) {
    if(!drawing) return;
    drawing = false;
    if(['line','rect','circle','ellipse','polygon'].includes(tool)) drawShape(e,true);
    if(tool==='text') drawShape(e,true);
    ctx.beginPath();
  }

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mouseup', endDraw);
  canvas.addEventListener('mouseout', endDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('touchstart', function(e) { drawing = true; startDraw(e); });
  canvas.addEventListener('touchend', endDraw);
  canvas.addEventListener('touchcancel', endDraw);
  canvas.addEventListener('touchmove', draw);

  function draw(e) {
    if (!drawing) return;
    const {x, y} = getXY(e);
    if(tool==='brush') {
      ctx.lineWidth = brushSize;
      ctx.lineCap = 'round';
      ctx.strokeStyle = brushColor;
      switch(brushType) {
        case 'pencil':
          ctx.globalAlpha = 1; ctx.setLineDash([]); ctx.globalCompositeOperation = 'source-over';
          // Pencil: add slight jitter for hand-drawn effect
          let jitter = (Math.random()-0.5)*2;
          ctx.lineTo(x+jitter, y+jitter);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x+jitter, y+jitter);
          return;
        case 'charcoal':
          ctx.globalAlpha = 0.2; ctx.lineWidth = brushSize * 2; ctx.setLineDash([]); ctx.globalCompositeOperation = 'source-over';
          // Charcoal: overlay grainy texture
          for(let i=0;i<brushSize*2;i++) {
            let angle = Math.random()*2*Math.PI;
            let radius = Math.random()*brushSize*1.5;
            let sx = x + Math.cos(angle)*radius;
            let sy = y + Math.sin(angle)*radius;
            ctx.save();
            ctx.globalAlpha = 0.15;
            ctx.beginPath();
            ctx.arc(sx, sy, brushSize/4, 0, 2*Math.PI);
            ctx.fillStyle = brushColor;
            ctx.fill();
            ctx.restore();
          }
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x, y);
          return;
        case 'graphite':
          ctx.globalAlpha = 0.7; ctx.setLineDash([]); ctx.globalCompositeOperation = 'source-over';
          // Graphite: smooth gradient shading
          let grad = ctx.createRadialGradient(x, y, brushSize/4, x, y, brushSize);
          grad.addColorStop(0, brushColor);
          grad.addColorStop(1, '#fff');
          ctx.strokeStyle = grad;
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x, y);
          return;
        case 'ink':
          ctx.globalAlpha = 1; ctx.lineCap = 'butt'; ctx.setLineDash([]); ctx.globalCompositeOperation = 'source-over';
          break;
        case 'eraser':
          ctx.globalAlpha = 1; ctx.setLineDash([]); ctx.globalCompositeOperation = 'destination-out'; ctx.strokeStyle = 'rgba(0,0,0,1)';
          break;
        case 'marker':
          ctx.globalAlpha = 0.8; ctx.setLineDash([]); ctx.globalCompositeOperation = 'source-over';
          // Marker: soft edge effect
          ctx.shadowColor = brushColor;
          ctx.shadowBlur = brushSize/2;
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.shadowBlur = 0;
          ctx.beginPath();
          ctx.moveTo(x, y);
          return;
        case 'airbrush':
          ctx.globalAlpha = 0.1; ctx.lineWidth = brushSize * 2; ctx.setLineDash([]); ctx.globalCompositeOperation = 'source-over';
          // Airbrush: more random spray dots
          for(let i=0;i<brushSize*8;i++) {
            let angle = Math.random()*2*Math.PI;
            let radius = Math.random()*brushSize*1.5;
            let sx = x + Math.cos(angle)*radius;
            let sy = y + Math.sin(angle)*radius;
            ctx.save();
            ctx.globalAlpha = 0.08;
            ctx.beginPath();
            ctx.arc(sx, sy, brushSize/5, 0, 2*Math.PI);
            ctx.fillStyle = brushColor;
            ctx.fill();
            ctx.restore();
          }
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x, y);
          return;
        case 'calligraphy':
          ctx.globalAlpha = 1; ctx.lineCap = 'butt'; ctx.setLineDash([]); ctx.globalCompositeOperation = 'source-over';
          // Calligraphy: angle effect
          let angleRad = Math.PI/6;
          ctx.save();
          ctx.translate(x, y);
          ctx.rotate(angleRad);
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.lineTo(brushSize, 0);
          ctx.strokeStyle = brushColor;
          ctx.lineWidth = brushSize;
          ctx.stroke();
          ctx.restore();
          ctx.beginPath();
          ctx.moveTo(x, y);
          return;
        case 'smudge':
          ctx.globalAlpha = 0.2; ctx.setLineDash([]); ctx.globalCompositeOperation = 'lighter';
          // Smudge: blend with previous color
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x, y);
          return;
        case 'blend':
          ctx.globalAlpha = 0.1; ctx.setLineDash([]); ctx.globalCompositeOperation = 'lighter';
          // Blend: more color mixing
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x, y);
          return;
        case 'spray':
          // Spray: more realistic spray
          for(let i=0;i<brushSize*10;i++) {
            let angle = Math.random()*2*Math.PI;
            let radius = Math.random()*brushSize;
            let sx = x + Math.cos(angle)*radius;
            let sy = y + Math.sin(angle)*radius;
            ctx.save();
            ctx.globalAlpha = 0.15;
            ctx.beginPath();
            ctx.arc(sx, sy, 1, 0, 2*Math.PI);
            ctx.fillStyle = brushColor;
            ctx.fill();
            ctx.restore();
          }
          return;
        case 'pattern':
          ctx.setLineDash([6,2]); ctx.globalCompositeOperation = 'source-over';
          // Pattern brush: alternating color
          ctx.strokeStyle = Math.random() > 0.5 ? brushColor : '#fff';
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x, y);
          return;
        case 'hatch':
          // Hatching: draw parallel lines
          ctx.save();
          ctx.strokeStyle = brushColor;
          ctx.globalAlpha = 0.5;
          for(let i=-brushSize;i<brushSize;i+=4) {
            ctx.beginPath(); ctx.moveTo(x+i,y-brushSize); ctx.lineTo(x+i,y+brushSize); ctx.stroke(); }
          ctx.globalAlpha = 1;
          ctx.restore();
          return;
        case 'crosshatch': crosshatch(x, y, brushSize, brushColor); ctx.setLineDash([]); ctx.globalCompositeOperation = 'source-over'; return;
        case 'dotted':
          ctx.setLineDash([]); ctx.globalCompositeOperation = 'source-over';
          let dotSpacing = brushSize * 2.5;
          if (lastDotX === null || lastDotY === null || Math.hypot(x - lastDotX, y - lastDotY) >= dotSpacing) {
            drawDot(x, y, brushSize, brushColor);
            lastDotX = x;
            lastDotY = y;
          }
          return;
        default: ctx.globalAlpha = 1; ctx.setLineDash([]); ctx.globalCompositeOperation = 'source-over'; break;
      }
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.setLineDash([]);
      ctx.globalAlpha = 1;
      ctx.lineCap = 'round';
      lastDotX = null; lastDotY = null;
    } else if(['line','rect','circle','ellipse','polygon','text'].includes(tool)) {
      drawShape(e,false);
    }
  }

  function drawShape(e, final) {
    if(!drawing && !final) return;
    const {x, y} = getXY(e);
    ctx.putImageData(snapshot,0,0);
    ctx.lineWidth = brushSize;
    ctx.strokeStyle = brushColor;
    ctx.fillStyle = brushColor;
    if(tool==='line') { ctx.beginPath(); ctx.moveTo(startX,startY); ctx.lineTo(x,y); ctx.stroke(); }
    if(tool==='rect') { ctx.beginPath(); ctx.rect(startX,startY,x-startX,y-startY); ctx.stroke(); }
    if(tool==='circle') { ctx.beginPath(); let r = Math.sqrt((x-startX)**2+(y-startY)**2); ctx.arc(startX,startY,r,0,2*Math.PI); ctx.stroke(); }
    if(tool==='ellipse') { ctx.beginPath(); ctx.ellipse(startX,startY,Math.abs(x-startX),Math.abs(y-startY),0,0,2*Math.PI); ctx.stroke(); }
    if(tool==='polygon') {
      if (!isDrawingPolygon) {
        polygonPoints = [{x: startX, y: startY}];
        isDrawingPolygon = true;
      }
      polygonPoints.push({x, y});
      ctx.beginPath();
      ctx.moveTo(polygonPoints[0].x, polygonPoints[0].y);
      for (let pt of polygonPoints) ctx.lineTo(pt.x, pt.y);
      ctx.stroke();
      if (final && polygonPoints.length > 2) {
        ctx.closePath();
        ctx.stroke();
        ctx.fill();
        isDrawingPolygon = false;
        polygonPoints = [];
      }
    }
    if(tool==='text' && final) {
      setTimeout(function() {
        let userText = prompt('Enter text:');
        if (userText) {
          ctx.font = `${brushSize*3}px Arial`;
          ctx.fillStyle = brushColor;
          ctx.fillText(userText, x, y);
        }
      }, 10);
    }
  }

  canvas.addEventListener('dblclick', function(e) {
    if(tool==='polygon' && isDrawingPolygon) {
      drawShape(e, true);
      isDrawingPolygon = false;
      polygonPoints = [];
    }
  });

  function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

  function saveDrawing() {
    const filename = prompt('Enter a name for your drawing:', 'my_sketch.png');
    if (!filename) return;
    // Save current canvas state
    const original = ctx.getImageData(0, 0, canvas.width, canvas.height);
    // Fill background with white
    ctx.save();
    ctx.globalCompositeOperation = 'destination-over';
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.restore();
    // Save PNG
    const dataURL = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.href = dataURL;
    link.download = filename.endsWith('.png') ? filename : filename + '.png';
    link.click();
    // Restore original drawing
    ctx.putImageData(original, 0, 0);
    document.getElementById('saveMsg').textContent = 'Sketch saved as ' + link.download + '! Check your downloads.';
    setTimeout(()=>{ document.getElementById('saveMsg').textContent = ''; }, 3000);
  }

  // Simple flood fill (bucket tool)
  function floodFill(x, y, fillColor) {
    ctx.fillStyle = fillColor;
    ctx.beginPath(); ctx.arc(x, y, 20, 0, 2 * Math.PI); ctx.fill();
  }

  // Spray tool
  function spray(x, y, size, color) {
    for(let i=0;i<size*5;i++) {
      let angle = Math.random()*2*Math.PI;
      let radius = Math.random()*size;
      let sx = x + Math.cos(angle)*radius;
      let sy = y + Math.sin(angle)*radius;
      ctx.fillStyle = color;
      ctx.globalAlpha = 0.2;
      ctx.fillRect(sx, sy, 1, 1);
    }
    ctx.globalAlpha = 1;
  }
  // Hatch tool
  function hatch(x, y, size, color) {
    ctx.strokeStyle = color;
    ctx.globalAlpha = 0.5;
    for(let i=-size;i<size;i+=4) {
      ctx.beginPath(); ctx.moveTo(x+i,y-size); ctx.lineTo(x+i,y+size); ctx.stroke(); }
    ctx.globalAlpha = 1;
  }
  // Crosshatch tool
  function crosshatch(x, y, size, color) {
    hatch(x, y, size, color);
    ctx.save(); ctx.translate(x, y); ctx.rotate(Math.PI/4);
    hatch(0, 0, size, color);
    ctx.restore();
  }

  // Add touch support for mobile drawing
  canvas.addEventListener('touchstart', function(e) {
    e.preventDefault();
    drawing = true;
    startDraw(e);
  });
  canvas.addEventListener('touchmove', function(e) {
    e.preventDefault();
    draw(e);
  });
  canvas.addEventListener('touchend', function(e) {
    e.preventDefault();
    endDraw(e);
  });
  canvas.addEventListener('touchcancel', function(e) {
    e.preventDefault();
    endDraw(e);
  });

  function drawDot(x, y, size, color) {
    ctx.save();
    ctx.beginPath();
    ctx.arc(x, y, size/2, 0, 2 * Math.PI);
    ctx.fillStyle = color;
    ctx.globalAlpha = 1;
    ctx.fill();
    ctx.restore();
  }

  const levels = [
    {text:'Draw a cat', icon:'üê±', img:'media/movies/download.jpeg'},
    {text:'Draw a house', icon:'üè†', img:'media/movies/635217f73e372771013edb4c-the-avengers-poster-marvel-movie-canvas1.jpg'},
    {text:'Draw a tree', icon:'üå≥', img:'media/movies/feUv2SYumXlT8E2RhzlYbZxfEGLG5AVrCPxP1gmAaCusxyPnA1.jpg'},
    {text:'Draw a car', icon:'üöó', img:'media/movies/f5VK0h2bprRhR6iRrixcuEfRxSUF4l14F66vQYrsJGmKZ5nTA1.jpg'},
    {text:'Draw a flower', icon:'üå∏', img:'media/movies/IQsBhg9t747dLhjXfsChIGZy4XfugER8BF0Gw5MDhIcnY5nTA1.jpg'},
    {text:'Draw a boat', icon:'‚õµ', img:'media/movies/feUv2SYumXlT8E2RhzlYbZxfEGLG5AVrCPxP1gmAaCusxyPnA1.jpg'},
    {text:'Draw a bird', icon:'üê¶', img:'media/movies/635217f73e372771013edb4c-the-avengers-poster-marvel-movie-canvas1.jpg'},
    {text:'Draw a sun', icon:'‚òÄÔ∏è', img:'media/movies/f5VK0h2bprRhR6iRrixcuEfRxSUF4l14F66vQYrsJGmKZ5nTA1.jpg'},
    {text:'Draw a fish', icon:'üêü', img:'media/movies/IQsBhg9t747dLhjXfsChIGZy4XfugER8BF0Gw5MDhIcnY5nTA1.jpg'},
    {text:'Draw a star', icon:'‚≠ê', img:'media/movies/download.jpeg'},
  {text:'Draw an apple', icon:'üçé', img:'https://res.cloudinary.com/djc3qirsl/image/upload/v1756897997/media/movies/uno1akwgos6rkbtrlqx6.webp'}
  ];
  let currentLevel = 0;
  function startSelfDrawing() {
    document.getElementById('modeSelect').style.display = 'none';
    document.getElementById('levelPrompt').style.display = 'none';
    document.getElementById('levelChooser').style.display = 'none';
    clearCanvas();
  }
  function showLevelChooser() {
    document.getElementById('modeSelect').style.display = 'none';
    document.getElementById('levelChooser').style.display = 'flex';
    renderLevelButtons();
  }
  function backToModeSelect() {
    document.getElementById('levelChooser').style.display = 'none';
    document.getElementById('modeSelect').style.display = 'flex';
  }
  function renderLevelButtons() {
    const levelBtns = document.getElementById('levelBtns');
    levelBtns.innerHTML = '';
    levels.forEach((level, idx) => {
      const btn = document.createElement('button');
      btn.className = 'kids-level-btn';
      btn.innerHTML = `<span class="kids-level-icon">${level.icon}</span> <span class="kids-level-text">${level.text}</span>`;
      btn.onclick = function() { startLevel(idx); };
      levelBtns.appendChild(btn);
    });
  }
  function startLevel(idx) {
    currentLevel = idx;
    document.getElementById('levelChooser').style.display = 'none';
    showLevelPrompt();
    clearCanvas();
  }
  function showLevelPrompt() {
    showLevelImage();
  }
  function showLevelImage() {
    const imgDiv = document.getElementById('levelSampleImg');
    if (!imgDiv) return;
  imgDiv.innerHTML = `<img src='${levels[currentLevel].img}' alt='Sample' style='max-width:320px;max-height:320px;border-radius:24px;border:4px solid #00b8ff;box-shadow:0 6px 24px #00b8ff44;'>`;
    imgDiv.style.display = 'block';
  }
  function nextLevel() {
    if(currentLevel < levels.length-1) {
      currentLevel++;
      showLevelPrompt();
      clearCanvas();
    } else {
      document.getElementById('levelPrompt').innerHTML = "<span style='font-size:2rem;'>üéâ</span> <span>All levels complete!</span> <button onclick='backToModeSelect()' class='kids-next-btn'>Choose Again</button>";
    }
  }

  // Image upload and draw on canvas
const imageLoader = document.getElementById('imageLoader');
if (imageLoader) {
  imageLoader.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      const img = new Image();
      img.onload = function() {
        // Clear canvas and draw the image centered and scaled
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let scale = Math.min(canvas.width / img.width, canvas.height / img.height, 1);
        let imgW = img.width * scale;
        let imgH = img.height * scale;
        let x = (canvas.width - imgW) / 2;
        let y = (canvas.height - imgH) / 2;
        ctx.drawImage(img, x, y, imgW, imgH);
        saveState();
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });
}
</script>
<style>
.kids-modal {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  background: linear-gradient(135deg,#00b8ff33 0%,#fff 100%);
  z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;
  animation: kidsPop 0.5s;
}
.kids-title {
  color: #00b8ff;
  font-size: 3.5rem;
  margin-bottom: 32px;
  font-family: 'Comic Sans MS', cursive, sans-serif;
  text-shadow: 2px 2px 0 #fff, 0 0 12px #00b8ff88;
}
.kids-mode-btns { display: flex; gap: 32px; }
.kids-mode-btn {
  font-size: 2.2rem;
  padding: 28px 56px;
  margin: 0 18px;
  border-radius: 24px;
  border: none;
  font-family: 'Comic Sans MS', cursive, sans-serif;
  box-shadow: 0 4px 18px #00b8ff44;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.kids-mode-btn.self { background: #00b8ff; color: #fff; }
.kids-mode-btn.levels { background: #fff; color: #00b8ff; border: 2px solid #00b8ff; }
.kids-mode-btn:hover { transform: scale(1.08); box-shadow: 0 4px 24px #00b8ff88; }
.kids-level-btns { display: flex; flex-wrap: wrap; gap: 18px; justify-content: center; margin-bottom: 24px; }
.kids-level-btns-scroll {
  max-height: 48vh;
  overflow-y: auto;
  padding: 8px 0;
}
.kids-level-btn {
  background: #fff;
  color: #00b8ff;
  border: 2px solid #00b8ff;
  border-radius: 24px;
  font-size: 2rem;
  font-family: 'Comic Sans MS', cursive, sans-serif;
  padding: 28px 48px;
  min-width: 240px;
  min-height: 80px;
  box-shadow: 0 4px 18px #00b8ff44;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 18px;
  transition: transform 0.2s, box-shadow 0.2s;
}
.kids-level-btn:hover { background: #00b8ff; color: #fff; transform: scale(1.07); box-shadow: 0 4px 24px #00b8ff88; }
.kids-level-icon { font-size: 3rem; }
.kids-level-text { font-size: 2rem; font-weight: 700; }
  .kids-back-btn {
    background: #eee;
    color: #00b8ff;
    border: none;
    border-radius: 18px;
    font-size: 2rem;
    padding: 18px 48px;
    margin-top: 18px;
    cursor: pointer;
    font-family: 'Comic Sans MS', cursive, sans-serif;
    box-shadow: 0 2px 12px #00b8ff44;
  }
.kids-back-btn:hover { background: #00b8ff; color: #fff; }
.kids-level-prompt {
  display: none; position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
  background: #fff; color: #00b8ff; padding: 18px 36px; border-radius: 16px; box-shadow: 0 2px 16px #00b8ff44; font-size: 1.5rem; z-index: 9999;
  font-family: 'Comic Sans MS', cursive, sans-serif;
  text-align: center;
}
.kids-next-btn {
  background: #00b8ff; color: #fff; border: none; border-radius: 10px; font-size: 1.1rem; padding: 8px 18px; margin-left: 18px; cursor: pointer; font-family: 'Comic Sans MS', cursive, sans-serif;
}
.kids-next-btn:hover { background: #fff; color: #00b8ff; border: 2px solid #00b8ff; }
@keyframes kidsPop { 0% { transform: scale(0.7); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
</style>
</body>
</html>

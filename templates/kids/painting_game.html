<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Painting Game</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
  html, body { height: 100%; margin: 0; padding: 0; background: #f5f3f3; }
  .drawing-toolbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    min-height: 28px;
    background: #f8f9fa;
    border-bottom: 2px solid #00b8ff;
    box-shadow: 0 4px 16px #00b8ff33;
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    align-items: flex-start;
    z-index: 100;
    padding: 4px 4px 4px 4px;
    border-radius: 32px;
    overflow-x: visible;
    white-space: normal;
  }
  .toolbar-row {
    display: flex;
    flex-direction: row;
    gap: 16px;
    align-items: center;
    width: 100%;
    margin-bottom: 4px;
    justify-content: flex-start;
    overflow-x: visible;
    flex-wrap: wrap;
    -webkit-overflow-scrolling: auto;
  }
  .drawing-toolbar .tool-btn, .drawing-toolbar .paint-btn {
    background: #fff;
    color: #00b8ff;
    border: 2px solid #00b8ff;
    padding: 20px 28px;
    border-radius: 20px;
    min-width: 80px;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.4rem;
    /* Slightly reduce text size inside buttons */
    & span, & .btn-text {
      font-size: 1.8rem;
      font-weight: bold;
    }
    box-shadow: 0 2px 8px #00b8ff22;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    margin-bottom: 2px;
}
.drawing-toolbar .kids-btn {
  background: #fff;
  color: #00b8ff;
  border: 2px solid #00b8ff;
  padding: 20px 28px;
  border-radius: 20px;
  min-width: 80px;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.4rem;
  font-weight: bold;
  box-shadow: 0 2px 8px #00b8ff22;
  transition: background 0.2s, color 0.2s, box-shadow 0.2s;
  margin-bottom: 2px;
}
.drawing-toolbar .kids-btn i {
  font-size: 2.4rem;
}
.drawing-toolbar .kids-btn.save {
  background: #00b8ff;
  color: #fff;
}
.drawing-toolbar .tool-btn i, .drawing-toolbar .paint-btn i {
    font-size: 2.4rem;
  }
  .drawing-toolbar .tool-btn.active, .drawing-toolbar .paint-btn.active {
    background: #00b8ff;
    color: #fff;
    box-shadow: 0 4px 16px #00b8ff44;
  }
  .drawing-toolbar .paint-btn.save {
    background: #00b8ff;
    color: #fff;
  }
  .drawing-toolbar .color-palette { display: flex; gap: 6px; margin-left: 8px; }
  .drawing-toolbar .color-swatch { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #00b8ff; cursor: pointer; transition: 0.2s; }
  .drawing-toolbar .color-swatch.selected { border: 3px solid #00b8ff; box-shadow: 0 0 8px #00b8ff88; }
  .mode-select-modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
    z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;
    animation: popIn 0.7s cubic-bezier(.4,2,.3,1);
  }
  @keyframes popIn {
    0% { transform: scale(0.7); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }
  .mode-select-modal h2 {
    color: #ff4066;
    font-size: 2.6rem;
    margin-bottom: 32px;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    text-shadow: 2px 2px 0 #fff, 0 0 12px #43c6ac;
    letter-spacing: 2px;
    animation: bounce 1.2s infinite alternate;
  }
  @keyframes bounce {
    0% { transform: translateY(0); }
    100% { transform: translateY(-12px); }
  }
  .mode-select-modal .mode-btns {
    display: flex;
    gap: 32px;
    flex-direction: row;
    justify-content: center;
    flex-wrap: wrap;
  }
  .mode-select-modal .mode-btn {
    font-size: 2.1rem;
    padding: 16px 24px;
    border-radius: 18px;
    min-width: 64px;
    min-height: 64px;
    font-size: 2.2rem;
    /* Adjust text size inside buttons */
    & span, & .btn-text {
      font-size: 1.4rem;
      font-weight: bold;
    }
    outline: none;
    border: 3px solid #ff4066;
    background: linear-gradient(135deg, #fff8dc 0%, #f8ffae 100%);
    color: #43c6ac;
    text-shadow: 1px 1px 0 #fff, 0 0 8px #ff4066;
  }
  .mode-select-modal .mode-btn.level {
    border-color: #ff4066;
    background: linear-gradient(135deg, #fff8dc 0%, #f8ffae 100%);
    color: #43c6ac;
  }
  .mode-select-modal .mode-btn.paint {
    border-color: #43c6ac;
    background: linear-gradient(135deg, #43c6ac 0%, #f8ffae 100%);
    color: #ff4066;
  }
  .mode-select-modal .mode-btn:hover {
    transform: scale(1.12) rotate(-2deg);
    box-shadow: 0 8px 32px #ff406688, 0 0 0 12px #fff8dc;
    background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
  }
  @media (max-width: 767px) {
    .mode-select-modal h2 { font-size: 2.1rem; margin-bottom: 18px; }
    .mode-select-modal .mode-btn { font-size: 1.4rem; padding: 18px 18px; border-radius: 22px; margin: 8px 0; }
    .mode-select-modal .mode-btns { gap: 18px; }
  }
  .level-chooser {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
    color: #ff4066; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    padding: 0;
    border-radius: 0;
    box-shadow: none;
    font-size: 2.2rem; z-index: 9999; display: none;
    animation: popIn 0.7s cubic-bezier(.4,2,.3,1);
    max-width: 100vw;
    overflow-y: auto;
  }
  .level-chooser .paint-btn {
    background: linear-gradient(135deg, #43c6ac 0%, #f8ffae 100%);
    color: #ff4066;
    border: 2px solid #ff4066;
    border-radius: 18px;
    font-size: 1.3rem;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    padding: 12px 32px;
    margin-top: 18px;
    font-weight: bold;
    box-shadow: 0 2px 12px #43c6ac44;
    cursor: pointer;
    transition: 0.2s;
    outline: none;
    animation: bounceBack 1.2s infinite alternate;
  }
    .level-chooser .paint-btn:hover {
      background: linear-gradient(135deg, #ff4066 0%, #f8ffae 100%);
      color: #43c6ac;
      border-color: #43c6ac;
      transform: scale(1.08) rotate(-2deg);
      box-shadow: 0 8px 24px #ff406688;
      animation: shakeBtn 0.4s;
    }
  @keyframes bounceBack {
    0% { transform: translateY(0); }
    100% { transform: translateY(-6px); }
  }
  .level-chooser h3 {
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    color: #ff4066;
    font-size: 3rem;
    margin-bottom: 28px;
    text-shadow: 2px 2px 0 #fff, 0 0 12px #43c6ac;
    letter-spacing: 2px;
    animation: bounce 1.2s infinite alternate;
  }
  .level-chooser .level-btns {
    display: flex; flex-wrap: wrap; gap: 38px; justify-content: center; margin-bottom: 32px;
  }
  .level-chooser .level-btn {
    background: linear-gradient(135deg, #fff8dc 0%, #f8ffae 100%);
    color: #43c6ac;
    border: 3px solid #ff4066;
    border-radius: 22px;
    font-size: 1.4rem;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    padding: 10px 24px;
    min-width: 120px; min-height: 32px;
    box-shadow: 0 4px 16px #43c6ac88, 0 0 0 6px #fff8dc;
    cursor: pointer; display: flex; align-items: center; gap: 14px; transition: 0.2s;
    font-weight: bold;
    outline: none;
    margin: 10px 0;
    position: relative;
    text-shadow: 1px 1px 0 #fff, 0 0 8px #ff4066;
    animation: bounceBtn 1.2s infinite alternate;
  }
  @keyframes bounceBtn {
    0% { transform: translateY(0); }
    100% { transform: translateY(-8px) scale(1.05); }
  }
  .level-chooser .level-btn:hover {
  background: linear-gradient(135deg, #ff4066 0%, #f8ffae 100%);
  color: #fff;
  transform: scale(1.15) rotate(-4deg);
  box-shadow: 0 16px 40px #ff406688, 0 0 0 18px #fff8dc;
  border-color: #43c6ac;
  text-shadow: 2px 2px 0 #43c6ac, 0 0 12px #ff4066;
  filter: brightness(1.15) drop-shadow(0 4px 12px #43c6ac88);
  animation: shakeBtn 0.4s;
}
@keyframes shakeBtn {
  0% { transform: scale(1.15) rotate(-4deg) translateX(0); }
  25% { transform: scale(1.15) rotate(-4deg) translateX(-4px); }
  50% { transform: scale(1.15) rotate(-4deg) translateX(4px); }
  75% { transform: scale(1.15) rotate(-4deg) translateX(-2px); }
  100% { transform: scale(1.15) rotate(-4deg) translateX(0); }
}
  .level-chooser .level-btn span {
    font-size: 1.8rem;
    margin-right: 8px;
    filter: drop-shadow(0 2px 4px #43c6ac88);
    animation: bounceIcon 1.2s infinite alternate;
  }
  @keyframes bounceIcon {
    0% { transform: translateY(0); }
    100% { transform: translateY(-6px); }
  }
  @media (max-width: 767px) {
      .level-chooser {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        font-size: 1.6rem; padding: 0; border-radius: 0;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
        box-shadow: none;
        z-index: 9999;
      }
      .level-chooser h3 { font-size: 2.2rem; margin-bottom: 18px; }
      .level-chooser .level-btn {
        font-size: 2.2rem;
        padding: 38px 28px;
        border-radius: 32px;
        min-width: 220px;
        min-height: 90px;
        box-shadow: 0 8px 32px #43c6ac88, 0 0 0 18px #fff8dc;
      }
      .level-chooser .level-btn span { font-size: 2.8rem; }
      .level-chooser .level-btns { gap: 28px; }
  }
  .import-modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
    z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; display: none;
    animation: popIn 0.7s cubic-bezier(.4,2,.3,1);
  }
  .import-modal .import-box {
  @media (max-width: 767px) {
    .import-modal {
      padding: 0;
      align-items: center;
      justify-content: center;
    overflow-y: auto;
    }
    .import-modal .import-box {
      width: auto;
      max-width: 92vw;
      min-width: 0;
      padding: 18px 0;
      border-radius: 18px;
      font-size: 1.1rem;
      box-sizing: border-box;
      margin-left: 4vw;
      margin-right: 4vw;
    margin-top: 8vh;
    margin-bottom: 8vh;
    max-height: 84vh;
    overflow-y: auto;
    }
    .import-modal .import-box h3 {
      font-size: 1.4rem;
      margin-bottom: 12px;
    }
    .import-modal input[type='file'] {
      font-size: 1rem;
      padding: 6px 8px;
    }
    .import-modal .import-btn {
      font-size: 1.1rem;
      padding: 10px 18px;
      border-radius: 12px;
    }
  }
    background: linear-gradient(135deg, #fff8dc 0%, #f8ffae 100%);
    color: #ff4066;
    padding: 38px 54px;
    border-radius: 28px;
    box-shadow: 0 4px 24px #43c6ac88, 0 0 0 8px #fff8dc;
    font-size: 1.6rem;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    text-align: center;
    animation: bounce 1.2s infinite alternate;
  }
  .import-modal .import-box h3 {
    color: #ff4066;
    font-size: 2.2rem;
    margin-bottom: 18px;
    text-shadow: 2px 2px 0 #fff, 0 0 12px #43c6ac;
    letter-spacing: 2px;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    animation: bounce 1.2s infinite alternate;
  }
  .import-modal input[type='file'] {
    margin-top: 18px;
    font-size: 1.2rem;
    border-radius: 12px;
    border: 2px solid #43c6ac;
    padding: 8px 12px;
    background: #fff8dc;
    color: #ff4066;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    box-shadow: 0 2px 8px #43c6ac44;
    transition: 0.2s;
  }
  .import-modal input[type='file']:hover {
    background: #f8ffae;
    border-color: #ff4066;
    color: #43c6ac;
  }
  .import-modal .import-btn {
    margin-top: 22px;
    background: linear-gradient(135deg, #43c6ac 0%, #f8ffae 100%);
    color: #ff4066;
    border: 2px solid #ff4066;
    border-radius: 18px;
    font-size: 1.4rem;
    padding: 14px 32px;
    cursor: pointer;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    font-weight: bold;
    box-shadow: 0 2px 12px #43c6ac44;
    transition: 0.2s;
    outline: none;
    animation: bounceBtn 1.2s infinite alternate;
  }
  .import-modal .import-btn:hover {
    background: linear-gradient(135deg, #ff4066 0%, #f8ffae 100%);
    color: #43c6ac;
    border-color: #43c6ac;
    transform: scale(1.08) rotate(-2deg);
    box-shadow: 0 8px 24px #ff406688;
    animation: shakeBtn 0.4s;
  }
  .canvas-container { position: fixed; top: 28px; left: 0; width: 100vw; height: calc(100vh - 28px); overflow: auto; background: #fff; z-index: 1; display: flex; align-items: center; justify-content: center; }
  #paintCanvas { display: block; cursor: crosshair; background: #fff; transition: transform 0.2s cubic-bezier(.4,2,.3,1); }
  @media (max-width: 1200px) { .drawing-toolbar { gap: 2px; padding: 0 1px; } .tool-btn, .paint-btn { min-width: 18px; font-size: 0.8rem; padding: 1px 2px; } .drawing-toolbar i { font-size: 0.85rem; } }
  @media (max-width: 767px) {
    .drawing-toolbar { font-size: 0.7rem; padding: 0 0.5px; gap: 1px; flex-wrap: wrap; }
    .tool-btn, .paint-btn { min-width: 14px; font-size: 0.7rem; padding: 1px 1px; }
    .drawing-toolbar i { font-size: 0.7rem; }
    .canvas-container { width: 100vw !important; height: calc(100vh - 80px) !important; }
  }
</style>
<div class="drawing-toolbar">
  <div class="toolbar-row">
    <button onclick="setTool('eraser')" id="eraserBtn" class="tool-btn" title="Eraser"><i class="fas fa-eraser"></i></button>
    <button onclick="setTool('spray')" id="sprayBtn" class="tool-btn" title="Spray Paint"><i class="fas fa-spray-can"></i></button>
    <button onclick="setTool('picker')" id="pickerBtn" class="tool-btn" title="Color Picker"><i class="fas fa-eye-dropper"></i></button>
    <button onclick="setTool('smudge')" id="smudgeBtn" class="tool-btn" title="Smudge/Blur"><i class="fas fa-water"></i></button>
    <button onclick="setTool('gradient')" id="gradientBtn" class="tool-btn" title="Gradient Brush"><i class="fas fa-adjust"></i></button>
    <button onclick="setTool('texture')" id="textureBtn" class="tool-btn" title="Pattern/Texture Brush"><i class="fas fa-grip-lines"></i></button>
    <label style="font-size:2rem; font-weight:bold; display:flex; align-items:center; gap:12px; background:#eafaff; padding:10px 18px; border-radius:18px; box-shadow:0 2px 8px #00b8ff22;">
      <span style="margin-right:8px;">Brush Size:</span>
      <input type="range" id="brushSize" min="2" max="64" value="12" style="width:120px; height:32px; accent-color:#00b8ff; margin-right:10px;">
      <span id="brushSizeValue" style="font-size:1.6rem; color:#00b8ff; font-weight:600; background:#fff; border-radius:8px; padding:2px 10px; box-shadow:0 1px 4px #00b8ff22;">12</span>
    </label>
    <label style="font-size:2.2rem; font-weight:bold; margin-left:16px; display:flex; align-items:center; gap:12px; background:#eafaff; padding:12px 20px; border-radius:18px; box-shadow:0 2px 8px #00b8ff22;">
      <span style="margin-right:8px;">Brush Color:</span>
      <input type="color" id="brushColorInput" value="#000000" style="width:48px; height:48px; border-radius:12px; border:2px solid #00b8ff; box-shadow:0 1px 4px #00b8ff22;">
      <span style="margin-left:18px; font-size:1.6rem; font-weight:600;">Brush Type:</span>
      <select id="brushType" style="font-size:1.4rem; border-radius:8px; border:2px solid #00b8ff; margin-left:8px; padding:4px 10px;">
  <option value="round">Round</option>
  <option value="calligraphy">Calligraphy</option>
  <option value="soft">Soft/Blur</option>
  <option value="marker">Marker</option>
  <option value="pattern">Pattern</option>
  <option value="rainbow">Rainbow</option>
      </select>
    </label>
    <label style="font-size:2.2rem; font-weight:bold; margin-left:16px; display:flex; align-items:center; gap:12px; background:#eafaff; padding:12px 20px; border-radius:18px; box-shadow:0 2px 8px #00b8ff22;">
      <span style="margin-right:8px;">Load Image:</span>
      <input type="file" id="importFile" accept="image/*" style="font-size:1.6rem; padding:8px 12px; border-radius:10px; border:2px solid #00b8ff; background:#fff; box-shadow:0 1px 4px #00b8ff22;" onchange="importDrawing()">
    </label>
  <button onclick="setTool('brush')" id="brushBtn" class="tool-btn active" title="Brush"><i class="fas fa-paint-brush"></i></button>
  <button onclick="setTool('fill')" id="fillBtn" class="tool-btn" title="Fill"><i class="fas fa-fill-drip"></i></button>
  <button onclick="setTool('text')" id="textBtn" class="tool-btn" title="Text Tool"><i class="fas fa-font"></i></button>
  <button onclick="zoomIn()" class="tool-btn" title="Zoom In"><i class="fas fa-search-plus"></i></button>
  <button onclick="zoomOut()" class="tool-btn" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
  <button onclick="undo()" class="kids-btn" title="Undo"><i class="fas fa-undo"></i></button>
  <button onclick="redo()" class="kids-btn" title="Redo"><i class="fas fa-redo"></i></button>
  <button onclick="clearCanvas()" class="kids-btn" title="Clear"><i class="fas fa-trash"></i></button>
  <button onclick="savePainting()" class="kids-btn save" title="Save"><i class="fas fa-save"></i></button>
    <span id="saveMsg" style="color:#00b8ff;font-weight:600;"></span>
  </div>
</div>
<!-- Reference image field moved below toolbar -->
<!-- Reference image fixed at bottom right -->
<img id="appleRefImg" src="https://res.cloudinary.com/djc3qirsl/image/upload/v1756897997/media/movies/uno1akwgos6rkbtrlqx6.webp" alt="Reference" style="position:fixed; left:18px; bottom:35cm; z-index:200; max-width:280px; max-height:280px; border-radius:22px; box-shadow:0 6px 24px #00b8ff44; background:#fff; border:5px dashed #ff4066;">
<div class="canvas-container"><canvas id="paintCanvas" width="1920" height="1080"></canvas></div>
<div id="modeSelect" class="mode-select-modal">
  <h2>üéâ Choose Your Fun Mode! üéâ</h2>
  <div class="mode-btns">
    <button onclick="startLevelMode()" class="mode-btn level">
      <span style="font-size:2.5rem;">üé®</span><br>Coloring Levels<br><span style="font-size:1.2rem;">(Fill colors in cool outlines!)</span>
    </button>
    <button onclick="startPaintMode()" class="mode-btn paint">
      <span style="font-size:2.5rem;">üñåÔ∏è</span><br>Paint Your Drawing<br><span style="font-size:1.2rem;">(Draw anything you like!)</span>
    </button>
  </div>
</div>
<div id="levelChooser" class="level-chooser">
  <h3>Choose a Level</h3>
  <div id="levelBtns" class="level-btns"></div>
  <div style="display:flex; justify-content:center; width:100%;">
    <button onclick="backToModeSelect()" class="paint-btn" style="margin:0 auto;">‚¨ÖÔ∏è Back</button>
  </div>
</div>
<div id="importModal" class="import-modal">
  <div class="import-box">
    <h3>Import Your Drawing</h3>
    <p style="font-size:1.2rem; color:#43c6ac;">Use the toolbar's Load Image button to import an image as your canvas background.</p>
  </div>
</div>
<script>
// Mobile pinch-to-zoom support
// Live brush size value update
document.getElementById('brushSize').addEventListener('input', function() {
  brushSize = this.value;
  document.getElementById('brushSizeValue').textContent = this.value;
});
// --- Autosave and Restore Logic ---
function autosavePainting() {
  try {
    localStorage.setItem('kids_painting_autosave', canvas.toDataURL());
  } catch (e) {}
}

function restorePainting() {
  const dataURL = localStorage.getItem('kids_painting_autosave');
  if (dataURL) {
    let img = new Image();
    img.src = dataURL;
    img.onload = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); };
  }
}

window.addEventListener('DOMContentLoaded', restorePainting);
let lastTouchDist = null;
const paintCanvas = document.getElementById('paintCanvas');
paintCanvas.addEventListener('touchstart', function(e) {
  if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    lastTouchDist = Math.sqrt(dx*dx + dy*dy);
  }
});
paintCanvas.addEventListener('touchmove', function(e) {
  if (e.touches.length === 2) {
    e.preventDefault();
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (lastTouchDist) {
      if (dist > lastTouchDist + 10) { zoom *= 1.1; applyZoom(); }
      else if (dist < lastTouchDist - 10) { zoom /= 1.1; applyZoom(); }
    }
    lastTouchDist = dist;
  }
});
paintCanvas.addEventListener('touchend', function(e) { lastTouchDist = null; });
const canvas = document.getElementById('paintCanvas');
const ctx = canvas.getContext('2d');
function resizeCanvas() {
  // Responsive canvas: fit window, max 3:2, but allow full width on mobile
  let w = window.innerWidth;
  let h = window.innerHeight - 28;
  let aspect = 3/2; // Make canvas even taller (3:2)
  if (w < 600) {
    // On mobile, use full width and height
    canvas.width = w;
    canvas.height = h;
  } else {
    if (w/h > aspect) {
      h = Math.min(h, w/aspect);
      w = h * aspect;
    } else {
      w = Math.min(w, h*aspect);
      h = w / aspect;
    }
    canvas.width = w;
    canvas.height = h;
  }
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();
let drawing = false, tool = 'brush', brushSize = 12, brushColor = '#000000', snapshot = null;
let brushType = 'round';
let history = [], redoStack = [];
let importedImage = null;
const paletteColors = [
  '#000000','#222222','#444444','#666666','#888888','#aaaaaa','#cccccc','#ffffff', // Grayscale
  '#ff0000','#ff4000','#ff8000','#ffbf00','#ffff00','#bfff00','#80ff00','#40ff00','#00ff00', // Reds/Oranges/Yellows/Greens
  '#00ff40','#00ff80','#00ffbf','#00ffff','#00bfff','#0080ff','#0040ff','#0000ff', // Blues
  '#4000ff','#8000ff','#bf00ff','#ff00ff','#ff00bf','#ff0080','#ff0040', // Purples/Pinks
  '#964B00','#FFD700','#C0C0C0','#A0522D','#8B4513','#D2691E','#F4A460','#DEB887','#FFF8DC' // Browns/Golds
];
function setTool(selected) {
  if(selected==='eraser') document.getElementById('eraserBtn').classList.add('active');
  if(selected==='spray') document.getElementById('sprayBtn').classList.add('active');
  if(selected==='picker') document.getElementById('pickerBtn').classList.add('active');
  if(selected==='text') document.getElementById('textBtn').classList.add('active');
  tool = selected;
  document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
  if(selected==='brush') document.getElementById('brushBtn').classList.add('active');
  if(selected==='fill') document.getElementById('fillBtn').classList.add('active');
  if(selected==='eraser') document.getElementById('eraserBtn').classList.add('active');
  if(selected==='spray') document.getElementById('sprayBtn').classList.add('active');
  if(selected==='picker') document.getElementById('pickerBtn').classList.add('active');
}
document.getElementById('brushSize').addEventListener('input', function() { brushSize = this.value; });
document.getElementById('brushColorInput').addEventListener('input', function() {
  brushColor = this.value;
});
document.getElementById('brushType').addEventListener('change', function() {
  brushType = this.value;
});
function getXY(e) {
  const rect = canvas.getBoundingClientRect();
  let x, y;
  if (e.touches) {
    x = e.touches[0].clientX - rect.left;
    y = e.touches[0].clientY - rect.top;
  } else {
    x = e.clientX - rect.left;
    y = e.clientY - rect.top;
  }
  return { x, y };
}
function saveState() {
  history.push(canvas.toDataURL());
  if(history.length > 50) history.shift();
  redoStack = [];
  autosavePainting();
}
function undo() {
  if(history.length < 2) return;
  redoStack.push(history.pop());
  let img = new Image();
  img.src = history[history.length-1];
  img.onload = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); autosavePainting(); };
}
function redo() {
  if(redoStack.length === 0) return;
  let img = new Image();
  img.src = redoStack.pop();
  img.onload = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); history.push(img.src); autosavePainting(); };
}
function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  autosavePainting();
}
canvas.addEventListener('mousedown', startDraw);
canvas.addEventListener('mouseup', endDraw);
canvas.addEventListener('mouseout', endDraw);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('touchstart', function(e) { drawing = true; startDraw(e); });
canvas.addEventListener('touchend', endDraw);
canvas.addEventListener('touchcancel', endDraw);
canvas.addEventListener('touchmove', draw);
function startDraw(e) {
  if(tool==='picker') {
    pickColor(e);
    drawing = false;
    return;
  }
  drawing = true;
  const {x, y} = getXY(e);
  if(tool==='brush' || tool==='eraser' || tool==='spray') {
    draw(e);
  }
  if(tool==='fill') floodFill(x, y, brushColor);
  saveState();
}
function endDraw(e) {
  if(!drawing) return;
  drawing = false;
  ctx.beginPath();
}
function draw(e) {
  if (!drawing) return;
  const {x, y} = getXY(e);
  if(tool==='brush') {
    ctx.save();
    ctx.lineWidth = brushSize;
    ctx.strokeStyle = brushColor;
    ctx.globalAlpha = 1;
    if(brushType==='round') {
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x, y);
      ctx.stroke();
    } else if(brushType==='calligraphy') {
      ctx.lineCap = 'round';
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(-Math.PI/6);
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(brushSize, 0);
      ctx.stroke();
      ctx.restore();
    } else if(brushType==='soft') {
      ctx.lineCap = 'round';
      ctx.globalAlpha = 0.3;
      ctx.beginPath();
      ctx.arc(x, y, brushSize/2, 0, 2*Math.PI);
      ctx.fillStyle = brushColor;
      ctx.fill();
      ctx.globalAlpha = 1;
    } else if(brushType==='marker') {
      ctx.lineCap = 'round';
      ctx.globalAlpha = 0.7;
      ctx.beginPath();
      ctx.arc(x, y, brushSize/2, 0, 2*Math.PI);
      ctx.fillStyle = brushColor;
      ctx.fill();
      ctx.globalAlpha = 1;
    } else if(brushType==='pattern') {
      ctx.lineCap = 'round';
      ctx.beginPath();
      for(let i=0; i<6; i++) {
        let angle = (Math.PI*2/6)*i;
        let px = x + Math.cos(angle)*brushSize/2;
        let py = y + Math.sin(angle)*brushSize/2;
        ctx.moveTo(x, y);
        ctx.lineTo(px, py);
      }
      ctx.stroke();
    } else if(brushType==='rainbow') {
      ctx.lineCap = 'round';
      let rainbowColors = ['#ff0000','#ff7f00','#ffff00','#00ff00','#0000ff','#4B0082','#9400D3'];
      for(let i=0; i<rainbowColors.length; i++) {
        ctx.beginPath();
        ctx.arc(x, y, brushSize/2 - i*2, 0, 2*Math.PI);
        ctx.strokeStyle = rainbowColors[i];
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      ctx.lineWidth = brushSize;
      ctx.strokeStyle = brushColor;
    }
    ctx.restore();
  }
  // Smudge/Blur tool
  if(tool==='smudge') {
    // Smudge: blend nearby pixels
    const radius = Math.max(brushSize, 8);
    const imageData = ctx.getImageData(x-radius, y-radius, radius*2, radius*2);
    const data = imageData.data;
    for(let i=0; i<data.length; i+=4) {
      // Simple blur: average with neighbors
      let avg = (data[i]+data[i+4]+data[i+radius*8]+data[i])/4;
      data[i] = data[i+1] = data[i+2] = avg;
    }
    ctx.putImageData(imageData, x-radius, y-radius);
  }
  // Gradient brush tool
  if(tool==='gradient') {
    // Draw a radial gradient at the cursor
    const grad = ctx.createRadialGradient(x, y, 0, x, y, brushSize);
    grad.addColorStop(0, brushColor);
    grad.addColorStop(1, '#fff');
    ctx.save();
    ctx.beginPath();
    ctx.arc(x, y, brushSize, 0, 2*Math.PI);
    ctx.fillStyle = grad;
    ctx.globalAlpha = 0.8;
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.restore();
  }
  // Pattern/Texture brush tool
  if(tool==='texture') {
    // Draw a checkerboard pattern
    ctx.save();
    for(let dx=-brushSize; dx<brushSize; dx+=brushSize/2) {
      for(let dy=-brushSize; dy<brushSize; dy+=brushSize/2) {
        ctx.beginPath();
        ctx.rect(x+dx, y+dy, brushSize/2, brushSize/2);
        ctx.fillStyle = ((Math.floor(dx/(brushSize/2))+Math.floor(dy/(brushSize/2)))%2===0)?brushColor:'#fff';
        ctx.globalAlpha = 0.7;
        ctx.fill();
      }
    }
    ctx.globalAlpha = 1;
    ctx.restore();
  }
  if(tool==='spray') {
    // Spray paint: draw random dots in a circle
    const density = Math.max(brushSize * 2, 20);
    for(let i=0; i<density; i++) {
      const angle = Math.random() * 2 * Math.PI;
      const radius = Math.random() * brushSize;
      const sx = x + Math.cos(angle) * radius;
      const sy = y + Math.sin(angle) * radius;
      ctx.fillStyle = brushColor;
      ctx.globalAlpha = 0.5 + Math.random()*0.5;
      ctx.beginPath();
      ctx.arc(sx, sy, 1 + brushSize/8, 0, 2*Math.PI);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }
  if(tool==='eraser') {
    ctx.lineWidth = brushSize;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#fff';
    ctx.globalAlpha = 1;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x, y);
    ctx.stroke();
  }
}

// Color picker (eyedropper) implementation
function pickColor(e) {
  let x, y;
  if (e.touches && e.touches.length > 0) {
    const rect = canvas.getBoundingClientRect();
    x = e.touches[0].clientX - rect.left;
    y = e.touches[0].clientY - rect.top;
  } else if (e.clientX !== undefined && e.clientY !== undefined) {
    const rect = canvas.getBoundingClientRect();
    x = e.clientX - rect.left;
    y = e.clientY - rect.top;
  } else {
    return;
  }
  x = Math.floor(x);
  y = Math.floor(y);
  if (x < 0 || y < 0 || x >= canvas.width || y >= canvas.height) return;
  try {
    const imageData = ctx.getImageData(x, y, 1, 1).data;
    const rgb = `#${((1<<24)+(imageData[0]<<16)+(imageData[1]<<8)+imageData[2]).toString(16).slice(1)}`;
    brushColor = rgb;
    document.getElementById('brushColorInput').value = rgb;
  } catch (err) {}
}
// Simple flood fill implementation (fills all connected pixels of the same color)
function floodFill(x, y, fillColor) {
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  const targetColor = getPixelColor(data, x, y);
  const fillRgba = hexToRgba(fillColor);
  if (colorsMatch(targetColor, fillRgba)) return;
  const stack = [[Math.floor(x), Math.floor(y)]];
  const width = canvas.width;
  const height = canvas.height;
  const visited = new Uint8Array(width * height);
  let count = 0;
  const maxFill = width * height * 0.25; // Prevent filling more than 25% of canvas
  while (stack.length && count < maxFill) {
    const [px, py] = stack.pop();
    if (px < 0 || px >= width || py < 0 || py >= height) continue;
    const idx = (py * width + px) * 4;
    const vIdx = py * width + px;
    if (visited[vIdx]) continue;
    visited[vIdx] = 1;
    const currentColor = [data[idx], data[idx+1], data[idx+2], data[idx+3]];
    if (!colorsMatch(currentColor, targetColor)) continue;
    data[idx] = fillRgba[0];
    data[idx+1] = fillRgba[1];
    data[idx+2] = fillRgba[2];
    data[idx+3] = 255;
    count++;
    stack.push([px-1, py]);
    stack.push([px+1, py]);
    stack.push([px, py-1]);
    stack.push([px, py+1]);
  }
  ctx.putImageData(imageData, 0, 0);
}

function getPixelColor(data, x, y) {
  const idx = (Math.floor(y) * canvas.width + Math.floor(x)) * 4;
  return [data[idx], data[idx+1], data[idx+2], data[idx+3]];
}
function hexToRgba(hex) {
  hex = hex.replace('#','');
  if (hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
  const num = parseInt(hex, 16);
  return [(num>>16)&255, (num>>8)&255, num&255, 255];
}
function colorsMatch(a, b) {
  // Use a tighter threshold for color match to avoid filling the whole image
  return Math.abs(a[0]-b[0])<8 && Math.abs(a[1]-b[1])<8 && Math.abs(a[2]-b[2])<8 && Math.abs(a[3]-b[3])<32;
}
function savePainting() {
  const filename = prompt('Enter a name for your painting:', 'my_painting.png');
  if (!filename) return;
  // Save current canvas state
  const original = ctx.getImageData(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.globalCompositeOperation = 'destination-over';
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.restore();
  const dataURL = canvas.toDataURL('image/png');
  const link = document.createElement('a');
  link.href = dataURL;
  link.download = filename.endsWith('.png') ? filename : filename + '.png';
  link.click();
  ctx.putImageData(original, 0, 0);
  document.getElementById('saveMsg').textContent = 'Painting saved as ' + link.download + '! Check your downloads.';
  setTimeout(()=>{ document.getElementById('saveMsg').textContent = ''; }, 3000);
}
// --- Mode Selection Logic ---
const levels = [
  {text:'Apple', icon:'üçé', outline:'https://res.cloudinary.com/djc3qirsl/image/upload/v1756897997/media/movies/aicbmbosj9fx0evqzyxe.png', ref:'https://res.cloudinary.com/djc3qirsl/image/upload/v1756897997/media/movies/uno1akwgos6rkbtrlqx6.webp'},
  {text:'House', icon:'üè†', outline:'media/movies/house-outline.png', ref:'media/movies/635217f73e372771013edb4c-the-avengers-poster-marvel-movie-canvas1.jpg'},
  {text:'Tree', icon:'üå≥', outline:'media/movies/tree-outline.png', ref:'media/movies/feUv2SYumXlT8E2RhzlYbZxfEGLG5AVrCPxP1gmAaCusxyPnA1.jpg'},
  {text:'Car', icon:'üöó', outline:'media/movies/car-outline.png', ref:'media/movies/f5VK0h2bprRhR6iRrixcuEfRxSUF4l14F66vQYrsJGmKZ5nTA1.jpg'}
];
let currentLevel = 0;
function startLevelMode() {
  document.getElementById('modeSelect').style.display = 'none';
  document.getElementById('levelChooser').style.display = 'block';
  renderLevelButtons();
}
function backToModeSelect() {
  document.getElementById('levelChooser').style.display = 'none';
  document.getElementById('modeSelect').style.display = 'flex';
}
function renderLevelButtons() {
  const levelBtns = document.getElementById('levelBtns');
  levelBtns.innerHTML = '';
  levels.forEach((level, idx) => {
    const btn = document.createElement('button');
    btn.className = 'level-btn';
    btn.innerHTML = `
      <span>${level.icon}</span>
      <span>${level.text}</span>
      <span style='font-size:1.1rem;color:#ff4066;'>${['Apple','House','Tree','Car'][idx] === 'Apple' ? 'üçè' : ['House','Tree','Car'][idx] === 'House' ? 'üè°' : ['House','Tree','Car'][idx] === 'Tree' ? 'üå≤' : 'üöô'}</span>
    `;
    btn.onclick = function() { startLevel(idx); };
    levelBtns.appendChild(btn);
  });
}
function startLevel(idx) {
  currentLevel = idx;
  document.getElementById('levelChooser').style.display = 'none';
  loadLevelOutline();
}
function loadLevelOutline() {
  clearCanvas();
  const img = new Image();
  // Use direct URL for external images, else add slash for local
  if (levels[currentLevel].outline.startsWith('http')) {
    img.src = levels[currentLevel].outline;
  } else {
    img.src = '/' + levels[currentLevel].outline;
  }
  img.onload = function() {
    // Always fit image horizontally, preserving natural orientation
    const canvasAspect = canvas.width / canvas.height;
    const imgAspect = img.width / img.height;
    let drawWidth, drawHeight, offsetX, offsetY;
    // Add vertical and horizontal padding (10% of each dimension)
    const vPad = canvas.height * 0.1;
    const hPad = canvas.width * 0.1;
    let availableHeight = canvas.height - 2 * vPad;
    let availableWidth = canvas.width - 2 * hPad;
    if (imgAspect > canvasAspect) {
      drawWidth = availableWidth;
      drawHeight = drawWidth / imgAspect;
      if (drawHeight > availableHeight) {
        drawHeight = availableHeight;
        drawWidth = drawHeight * imgAspect;
      }
    } else {
      drawHeight = availableHeight;
      drawWidth = drawHeight * imgAspect;
      if (drawWidth > availableWidth) {
        drawWidth = availableWidth;
        drawHeight = drawWidth / imgAspect;
      }
    }
    offsetX = (canvas.width - drawWidth) / 2;
    offsetY = (canvas.height - drawHeight) / 2;
    ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
  };
  // Show apple reference image only for Apple level
  const imgDiv = document.getElementById('levelSampleImg');
  if (levels[currentLevel].text === 'Apple') {
    imgDiv.innerHTML = `<img src='/media/movies/apple-439397_640.webp' alt='Sample' style='max-width:120px;max-height:120px;border-radius:12px;border:2px solid #00b8ff;box-shadow:0 2px 8px #00b8ff44;'>`;
    imgDiv.style.display = 'block';
  } else {
    imgDiv.innerHTML = '';
    imgDiv.style.display = 'none';
  }
  // Optionally show reference image
  // You can add a reference image display here if needed
}
function startPaintMode() {
  document.getElementById('modeSelect').style.display = 'none';
  document.getElementById('importModal').style.display = 'none'; // Hide import modal by default
  document.getElementById('levelChooser').style.display = 'none';
}

// Show Import Modal from toolbar (global function)
function showImportModal() {
  document.getElementById('importModal').style.display = 'flex';
}
function importDrawing() {
  const fileInput = document.getElementById('importFile');
  if (fileInput.files.length === 0) return;
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    // Draw imported image as the canvas background, filling the canvas
    const img = new Image();
    img.src = e.target.result;
    img.onload = function() {
      ctx.save();
      ctx.globalCompositeOperation = 'destination-over';
      // Fit image to canvas, no padding, always fills canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      ctx.restore();
      document.getElementById('importModal').style.display = 'none';
      document.getElementById('modeSelect').style.display = 'none';
      document.getElementById('levelChooser').style.display = 'none';
      autosavePainting();
    };
  };
  reader.readAsDataURL(file);
}
</script>
</body>
</html>
